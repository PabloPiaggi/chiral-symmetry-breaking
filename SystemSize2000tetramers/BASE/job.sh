#!/bin/bash
#SBATCH --job-name="M-T-TEMP"
#SBATCH --nodes=1                # node count
#SBATCH --ntasks=28               # total number of tasks across all nodes
#SBATCH --cpus-per-task=1        # cpu-cores per task (>1 if multi-threaded tasks)
#SBATCH --time=144:00:00

module purge
module load intel/2021.1.2
module load intel-mpi/intel/2021.1.1
module load anaconda3/2021.5
module load fftw/intel-2021.1/intel-mpi/3.3.9

############################################################################
# Variables definition
############################################################################
EXE=/scratch/gpfs/ppiaggi/Simulations/ChiralTetramer/Lammps/lammps-1Feb14/src/lmp_mpi
cycles=1
############################################################################


############################################################################
# Run
############################################################################
if [ -e runno ] ; then
   #########################################################################
   # Restart runs
   #########################################################################
   nn=`tail -n 1 runno | awk '{print $1}'`
   srun $EXE -in in.restart.lammps
   #########################################################################
else
   #########################################################################
   # First run
   #########################################################################
   nn=1
   srun $EXE -in in.lammps
   #########################################################################
fi
############################################################################

############################################################################
# Prepare next run
############################################################################
# Back up
############################################################################
cp log.lammps log.lammps.${nn}
cp dump.tetramer dump.tetramer.${nn}
last_restart=$(ls -1v tetramer.restart.* | tail -n 1)
echo ${last_restart}
cp ${last_restart} tetramer.restart 
############################################################################

############################################################################
# Check number of cycles
############################################################################
mm=$((nn+1))
echo ${mm} > runno
#cheking number of cycles
if [ ${nn} -ge ${cycles} ]; then
  exit
fi
############################################################################

############################################################################
# Resubmitting again
############################################################################
sbatch < job.sh
############################################################################

date
